name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: Install dependencies
      run: pnpm install
      
    - name: Build Chrome extension
      run: pnpm build
      
    - name: Build Firefox extension
      run: pnpm build:firefox
      
    - name: Create Chrome zip
      run: pnpm zip
      
    - name: Create Firefox zip
      run: pnpm zip:firefox
      
    - name: Get version from Git tag
      id: get-version
      run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
    - name: Verify zip files exist
      run: |
        VERSION=${{ steps.get-version.outputs.version }}
        CHROME_ZIP=".output/akshot-${VERSION}-chrome.zip"
        FIREFOX_ZIP=".output/akshot-${VERSION}-firefox.zip"
        
        if [ ! -f "$CHROME_ZIP" ]; then
          echo "âŒ Chrome zip file not found: $CHROME_ZIP"
          exit 1
        fi
        
        if [ ! -f "$FIREFOX_ZIP" ]; then
          echo "âŒ Firefox zip file not found: $FIREFOX_ZIP"
          exit 1
        fi
        
        echo "âœ… Both zip files found:"
        echo "  - Chrome: $CHROME_ZIP"
        echo "  - Firefox: $FIREFOX_ZIP"
      
    - name: Create Release
      id: create-release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: Release v${{ steps.get-version.outputs.version }}
        body: |
          ## ğŸš€ AkShot v${{ steps.get-version.outputs.version }}
          
          ### ğŸ“¦ å®‰è£…åŒ…ä¸‹è½½
          - **Chrome/Edge**: [akshot-${{ steps.get-version.outputs.version }}-chrome.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/akshot-${{ steps.get-version.outputs.version }}-chrome.zip)
          - **Firefox**: [akshot-${{ steps.get-version.outputs.version }}-firefox.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/akshot-${{ steps.get-version.outputs.version }}-firefox.zip)
          
          ### ğŸ“‹ å®‰è£…è¯´æ˜
          1. ä¸‹è½½å¯¹åº”æµè§ˆå™¨çš„å®‰è£…åŒ…
          2. è§£å‹ zip æ–‡ä»¶
          3. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ‰©å±•ç®¡ç†é¡µé¢
          4. å¯ç”¨ã€Œå¼€å‘è€…æ¨¡å¼ã€
          5. ç‚¹å‡»ã€ŒåŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åºã€
          6. é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
          
          ### ğŸ”„ æ›´æ–°å†…å®¹
          è¯·æŸ¥çœ‹ [æäº¤å†å²](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) äº†è§£è¯¦ç»†æ›´æ”¹ã€‚
        draft: false
        prerelease: false
        files: |
          .output/akshot-${{ steps.get-version.outputs.version }}-chrome.zip
          .output/akshot-${{ steps.get-version.outputs.version }}-firefox.zip
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: extension-builds
        path: |
          .output/*.zip
          .output/chrome-mv3-prod/
          .output/firefox-mv2-prod/
        retention-days: 30