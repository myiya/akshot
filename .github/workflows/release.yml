name: Build and Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: Install dependencies
      run: pnpm install
      
    - name: Build Chrome extension
      run: pnpm build
      
    - name: Build Firefox extension
      run: pnpm build:firefox
      
    - name: Create Chrome zip
      run: pnpm zip
      
    - name: Create Firefox zip
      run: pnpm zip:firefox
      
    - name: Get version from package.json
      id: package-version
      run: echo "version=$(node -p \"require('./package.json').version\")" >> $GITHUB_OUTPUT
      
    - name: Find Chrome zip file
      id: chrome-zip
      run: echo "path=$(find .output -name '*chrome*.zip' | head -1)" >> $GITHUB_OUTPUT
      
    - name: Find Firefox zip file
      id: firefox-zip
      run: echo "path=$(find .output -name '*firefox*.zip' | head -1)" >> $GITHUB_OUTPUT
      
    - name: Upload Chrome extension
      if: steps.chrome-zip.outputs.path != ''
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ${{ steps.chrome-zip.outputs.path }}
        asset_name: akshot-${{ steps.package-version.outputs.version }}-chrome.zip
        asset_content_type: application/zip
        
    - name: Upload Firefox extension
      if: steps.firefox-zip.outputs.path != ''
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ${{ steps.firefox-zip.outputs.path }}
        asset_name: akshot-${{ steps.package-version.outputs.version }}-firefox.zip
        asset_content_type: application/zip
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: extension-builds
        path: |
          .output/*.zip
          .output/chrome-mv3-prod/
          .output/firefox-mv2-prod/
        retention-days: 30